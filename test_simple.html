<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .test-image {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 简单测试页面</h1>
    <p>测试图片处理和下载功能</p>
    
    <div class="test-section">
        <h2>1. 创建测试图片</h2>
        <button onclick="createTestImage()">创建测试图片 (896×1152)</button>
        <div id="testImageContainer"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 测试图片尺寸调整</h2>
        <button onclick="testResize()">调整到 1440×1800</button>
        <div id="resizeResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 测试下载功能</h2>
        <button onclick="testDownload()">下载图片</button>
        <div id="downloadResult"></div>
    </div>

    <script>
        let testImageDataUrl = null;
        let resizedImageDataUrl = null;
        
        // 创建测试图片
        function createTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 创建一个简单的测试图片 (896×1152)
            canvas.width = 896;
            canvas.height = 1152;
            
            // 绘制渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 896, 1152);
            gradient.addColorStop(0, '#ff6b6b');
            gradient.addColorStop(1, '#4ecdc4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 896, 1152);
            
            // 添加文字
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('测试图片', 448, 576);
            ctx.font = '24px Arial';
            ctx.fillText('896×1152', 448, 620);
            
            // 生成data URL
            testImageDataUrl = canvas.toDataURL('image/png');
            
            // 显示图片
            const container = document.getElementById('testImageContainer');
            container.innerHTML = `
                <img src="${testImageDataUrl}" class="test-image" alt="测试图片">
                <p>尺寸: 896 × 1152 像素</p>
            `;
            
            console.log('测试图片已创建:', testImageDataUrl.substring(0, 100) + '...');
        }
        
        // 测试图片尺寸调整
        function testResize() {
            if (!testImageDataUrl) {
                alert('请先创建测试图片');
                return;
            }
            
            const resultDiv = document.getElementById('resizeResult');
            resultDiv.textContent = '正在调整图片尺寸...';
            
            // 使用前端Canvas调整图片尺寸
            fastResizeImage(testImageDataUrl, 1440, 1800)
                .then(resizedUrl => {
                    resizedImageDataUrl = resizedUrl;
                    resultDiv.innerHTML = `
                        <img src="${resizedUrl}" class="test-image" alt="调整后的图片">
                        <p>调整后尺寸: 1440 × 1800 像素</p>
                        <p>✅ 图片尺寸调整成功！</p>
                    `;
                    console.log('图片尺寸调整成功');
                })
                .catch(error => {
                    resultDiv.innerHTML = `
                        <p>❌ 图片尺寸调整失败: ${error.message}</p>
                    `;
                    console.error('图片尺寸调整失败:', error);
                });
        }
        
        // 测试下载功能
        function testDownload() {
            const imageUrl = resizedImageDataUrl || testImageDataUrl;
            
            if (!imageUrl) {
                alert('请先创建或调整图片');
                return;
            }
            
            const resultDiv = document.getElementById('downloadResult');
            resultDiv.textContent = '正在下载图片...';
            
            try {
                // 创建下载链接
                const link = document.createElement('a');
                link.href = imageUrl;
                
                // 生成文件名
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `test-image-${timestamp}.png`;
                
                link.download = filename;
                link.style.display = 'none';
                
                // 添加到DOM，点击，然后清理
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                resultDiv.innerHTML = `
                    <p>✅ 图片下载成功！</p>
                    <p>文件名: ${filename}</p>
                `;
                console.log('图片下载成功');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <p>❌ 图片下载失败: ${error.message}</p>
                `;
                console.error('图片下载失败:', error);
            }
        }
        
        // 前端图片尺寸调整函数
        function fastResizeImage(imageUrl, targetWidth, targetHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const timeout = setTimeout(() => {
                    reject(new Error('图片加载超时'));
                }, 10000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // 绘制缩放后的图片
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        
                        // 转换为高质量PNG格式
                        const resizedUrl = canvas.toDataURL('image/png', 1.0);
                        console.log(`图片尺寸调整完成: ${targetWidth}x${targetHeight}`);
                        resolve(resizedUrl);
                    } catch (error) {
                        console.error('Canvas处理失败:', error);
                        reject(new Error('图片处理失败: ' + error.message));
                    }
                };
                
                img.onerror = (error) => {
                    clearTimeout(timeout);
                    console.error('图片加载失败:', error);
                    reject(new Error('图片加载失败'));
                };
                
                img.src = imageUrl;
            });
        }
        
        // 页面加载时自动创建测试图片
        window.addEventListener('load', () => {
            console.log('简单测试页面已加载');
            setTimeout(() => {
                createTestImage();
            }, 500);
        });
    </script>
</body>
</html>
