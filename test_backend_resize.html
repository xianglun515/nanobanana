<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后端图片分辨率调整测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .test-image {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .result {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .highlight {
            background: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .comparison {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-item {
            flex: 1;
            text-align: center;
        }
        .comparison-image {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .api-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .api-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .api-response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 后端图片分辨率调整测试</h1>
    <p>此页面用于测试后端图片分辨率调整功能</p>
    
    <div class="test-section">
        <h2>📋 后端图片处理架构</h2>
        <div class="test-item info">
            <h3>处理流程：</h3>
            <ol>
                <li><strong>AI生成图片</strong>：AI模型生成图片（可能尺寸不匹配）</li>
                <li><strong>后端检测</strong>：后端检测到尺寸不匹配</li>
                <li><strong>后端调整</strong>：后端使用专门的图片处理函数调整尺寸</li>
                <li><strong>返回结果</strong>：返回调整后的图片URL给前端</li>
                <li><strong>前端显示</strong>：前端直接显示调整后的图片</li>
            </ol>
            <p><strong>优势</strong>：后端处理更可靠，前端无需额外处理</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>🧪 API测试</h2>
        
        <div class="test-item">
            <h3>1. 图片尺寸调整API测试</h3>
            <div class="api-test">
                <label>图片URL (data URL或外部URL):</label>
                <input type="text" id="imageUrlInput" class="api-input" placeholder="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
                
                <label>目标宽度:</label>
                <input type="number" id="targetWidthInput" class="api-input" value="1440" min="1" max="4096">
                
                <label>目标高度:</label>
                <input type="number" id="targetHeightInput" class="api-input" value="1800" min="1" max="4096">
                
                <br>
                <button onclick="testResizeAPI()">测试图片尺寸调整API</button>
                <button onclick="createTestImage()">创建测试图片</button>
            </div>
            <div id="apiResult" class="api-response"></div>
        </div>
        
        <div class="test-item">
            <h3>2. 完整的AI修图流程测试</h3>
            <div class="api-test">
                <label>API Key:</label>
                <input type="text" id="apiKeyInput" class="api-input" placeholder="输入你的API Key">
                
                <label>修图提示词:</label>
                <input type="text" id="promptInput" class="api-input" value="删除小孩" placeholder="输入修图提示词">
                
                <label>原始宽度:</label>
                <input type="number" id="originalWidthInput" class="api-input" value="1080" min="1" max="4096">
                
                <label>原始高度:</label>
                <input type="number" id="originalHeightInput" class="api-input" value="1440" min="1" max="4096">
                
                <br>
                <button onclick="testFullEditFlow()">测试完整修图流程</button>
            </div>
            <div id="fullFlowResult" class="api-response"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>📊 结果对比</h2>
        
        <div class="test-item">
            <h3>3. 尺寸对比</h3>
            <div class="comparison">
                <div class="comparison-item">
                    <h4>AI原始输出</h4>
                    <img id="comparisonOriginal" class="comparison-image" alt="AI原始输出">
                    <p id="originalSize">尺寸: 等待生成...</p>
                </div>
                <div class="comparison-item">
                    <h4>后端调整后</h4>
                    <img id="comparisonResized" class="comparison-image" alt="后端调整后">
                    <p id="resizedSize">尺寸: 等待调整...</p>
                </div>
            </div>
            <button onclick="updateComparison()">更新对比</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>🔧 技术实现</h2>
        <div class="test-item success">
            <h3>后端实现：</h3>
            <ul>
                <li><strong>图片下载</strong>：<code>downloadImageFromUrl()</code> 下载外部图片</li>
                <li><strong>尺寸调整</strong>：<code>resizeImageToTargetDimensions()</code> 调整图片尺寸</li>
                <li><strong>外部服务</strong>：<code>resizeImageWithExternalService()</code> 支持外部图像处理服务</li>
                <li><strong>API端点</strong>：<code>/resize-image</code> 专门的图片调整端点</li>
            </ul>
        </div>
        <div class="test-item success">
            <h3>前端适配：</h3>
            <ul>
                <li><strong>后端检测</strong>：检测 <code>backendResized</code> 标志</li>
                <li><strong>直接显示</strong>：后端已处理时直接显示调整后的图片</li>
                <li><strong>降级处理</strong>：后端未处理时前端处理</li>
                <li><strong>下载优化</strong>：下载时确保是正确尺寸的图片</li>
            </ul>
        </div>
    </div>

    <script>
        let testImageDataUrl = null;
        let resizedImageDataUrl = null;
        
        // 创建测试图片
        function createTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 创建一个简单的测试图片 (896×1152)
            canvas.width = 896;
            canvas.height = 1152;
            
            // 绘制渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 896, 1152);
            gradient.addColorStop(0, '#ff6b6b');
            gradient.addColorStop(1, '#4ecdc4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 896, 1152);
            
            // 添加文字
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('测试图片', 448, 576);
            ctx.font = '24px Arial';
            ctx.fillText('896×1152', 448, 620);
            
            // 生成data URL
            testImageDataUrl = canvas.toDataURL('image/png');
            document.getElementById('imageUrlInput').value = testImageDataUrl;
            
            // 更新对比图片
            document.getElementById('comparisonOriginal').src = testImageDataUrl;
            document.getElementById('originalSize').textContent = '尺寸: 896 × 1152 像素';
            
            console.log('测试图片已创建:', testImageDataUrl.substring(0, 100) + '...');
        }
        
        // 测试图片尺寸调整API
        async function testResizeAPI() {
            const imageUrl = document.getElementById('imageUrlInput').value;
            const targetWidth = parseInt(document.getElementById('targetWidthInput').value);
            const targetHeight = parseInt(document.getElementById('targetHeightInput').value);
            
            if (!imageUrl) {
                alert('请输入图片URL');
                return;
            }
            
            if (!targetWidth || !targetHeight) {
                alert('请输入有效的目标尺寸');
                return;
            }
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = '正在测试API...';
            
            try {
                const response = await fetch('/resize-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: imageUrl,
                        targetWidth: targetWidth,
                        targetHeight: targetHeight
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `API测试成功！\n\n原始URL: ${data.originalUrl.substring(0, 100)}...\n调整后URL: ${data.resizedUrl.substring(0, 100)}...\n目标尺寸: ${data.targetDimensions.width} × ${data.targetDimensions.height}\n处理时间: ${data.processedAt}\n成功: ${data.success}`;
                    
                    // 保存调整后的图片URL
                    resizedImageDataUrl = data.resizedUrl;
                    
                    // 更新对比图片
                    document.getElementById('comparisonResized').src = data.resizedUrl;
                    document.getElementById('resizedSize').textContent = `尺寸: ${data.targetDimensions.width} × ${data.targetDimensions.height} 像素`;
                    
                } else {
                    resultDiv.textContent = `API测试失败！\n\n错误: ${data.error}\n状态码: ${response.status}`;
                }
                
            } catch (error) {
                resultDiv.textContent = `API测试出错！\n\n错误: ${error.message}`;
            }
        }
        
        // 测试完整的AI修图流程
        async function testFullEditFlow() {
            const apiKey = document.getElementById('apiKeyInput').value;
            const prompt = document.getElementById('promptInput').value;
            const originalWidth = parseInt(document.getElementById('originalWidthInput').value);
            const originalHeight = parseInt(document.getElementById('originalHeightInput').value);
            
            if (!apiKey) {
                alert('请输入API Key');
                return;
            }
            
            if (!prompt) {
                alert('请输入修图提示词');
                return;
            }
            
            // 使用测试图片
            if (!testImageDataUrl) {
                alert('请先创建测试图片');
                return;
            }
            
            const resultDiv = document.getElementById('fullFlowResult');
            resultDiv.textContent = '正在测试完整修图流程...';
            
            try {
                const response = await fetch('/edit-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: [testImageDataUrl],
                        prompt: prompt,
                        originalWidth: originalWidth,
                        originalHeight: originalHeight,
                        apikey: apiKey,
                        model: 'gemini-2.5-flash-image-preview'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `完整修图流程测试成功！\n\n图片URL: ${data.imageUrl.substring(0, 100)}...\n原始尺寸: ${data.originalDimensions.width} × ${data.originalDimensions.height}\n目标尺寸: ${data.targetDimensions.width} × ${data.targetDimensions.height}\n后端调整: ${data.backendResized}\n处理时间: ${data.processedAt}`;
                    
                    // 更新对比图片
                    document.getElementById('comparisonResized').src = data.imageUrl;
                    document.getElementById('resizedSize').textContent = `尺寸: ${data.targetDimensions.width} × ${data.targetDimensions.height} 像素`;
                    
                } else {
                    resultDiv.textContent = `完整修图流程测试失败！\n\n错误: ${data.error}\n状态码: ${response.status}`;
                }
                
            } catch (error) {
                resultDiv.textContent = `完整修图流程测试出错！\n\n错误: ${error.message}`;
            }
        }
        
        // 更新对比
        function updateComparison() {
            if (testImageDataUrl) {
                document.getElementById('comparisonOriginal').src = testImageDataUrl;
                document.getElementById('originalSize').textContent = '尺寸: 896 × 1152 像素';
            }
            if (resizedImageDataUrl) {
                document.getElementById('comparisonResized').src = resizedImageDataUrl;
                // 尺寸信息会在API调用后更新
            }
        }
        
        // 页面加载时自动创建测试图片
        window.addEventListener('load', () => {
            console.log('后端图片分辨率调整测试页面已加载');
            setTimeout(() => {
                createTestImage();
            }, 500);
        });
    </script>
</body>
</html>
