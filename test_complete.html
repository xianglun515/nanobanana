<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .test-image {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å®Œæ•´åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    <p>æµ‹è¯•å›¾ç‰‡å¤„ç†ã€å°ºå¯¸è°ƒæ•´å’Œä¸‹è½½åŠŸèƒ½</p>
    
    <div class="test-section">
        <h2>1. åˆ›å»ºæµ‹è¯•å›¾ç‰‡</h2>
        <button onclick="createTestImage()">åˆ›å»ºæµ‹è¯•å›¾ç‰‡ (1440Ã—1800)</button>
        <div id="testImageContainer"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ¨¡æ‹ŸAIå¤„ç†</h2>
        <button onclick="simulateAIProcessing()">æ¨¡æ‹ŸAIå¤„ç† (è¾“å‡º896Ã—1152)</button>
        <div id="aiResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æµ‹è¯•å°ºå¯¸è°ƒæ•´</h2>
        <button onclick="testResize()">è°ƒæ•´åˆ°åŸå§‹å°ºå¯¸ (1440Ã—1800)</button>
        <div id="resizeResult"></div>
    </div>
    
    <div class="test-section">
        <h2>4. æµ‹è¯•ä¸‹è½½åŠŸèƒ½</h2>
        <button onclick="testDownload()">ä¸‹è½½è°ƒæ•´åçš„å›¾ç‰‡</button>
        <div id="downloadResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. æµ‹è¯•æ—¥å¿—</h2>
        <div id="logContainer" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let testImageDataUrl = null;
        let aiProcessedImageUrl = null;
        let resizedImageUrl = null;
        let originalDimensions = { width: 1440, height: 1800 };
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // åˆ›å»ºæµ‹è¯•å›¾ç‰‡
        function createTestImage() {
            log('å¼€å§‹åˆ›å»ºæµ‹è¯•å›¾ç‰‡...');
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // åˆ›å»ºåŸå§‹å°ºå¯¸çš„æµ‹è¯•å›¾ç‰‡ (1440Ã—1800)
            canvas.width = originalDimensions.width;
            canvas.height = originalDimensions.height;
            
            // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#ff6b6b');
            gradient.addColorStop(1, '#4ecdc4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ·»åŠ æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = 'bold 72px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('åŸå§‹å›¾ç‰‡', canvas.width/2, canvas.height/2 - 50);
            ctx.font = '36px Arial';
            ctx.fillText(`${canvas.width}Ã—${canvas.height}`, canvas.width/2, canvas.height/2 + 50);
            
            // ç”Ÿæˆdata URL
            testImageDataUrl = canvas.toDataURL('image/png');
            
            // æ˜¾ç¤ºå›¾ç‰‡
            const container = document.getElementById('testImageContainer');
            container.innerHTML = `
                <img src="${testImageDataUrl}" class="test-image" alt="æµ‹è¯•å›¾ç‰‡">
                <div class="status success">âœ… æµ‹è¯•å›¾ç‰‡åˆ›å»ºæˆåŠŸ</div>
                <p>å°ºå¯¸: ${canvas.width} Ã— ${canvas.height} åƒç´ </p>
            `;
            
            log(`æµ‹è¯•å›¾ç‰‡åˆ›å»ºæˆåŠŸ: ${canvas.width}Ã—${canvas.height}`);
        }
        
        // æ¨¡æ‹ŸAIå¤„ç†
        function simulateAIProcessing() {
            if (!testImageDataUrl) {
                alert('è¯·å…ˆåˆ›å»ºæµ‹è¯•å›¾ç‰‡');
                return;
            }
            
            log('å¼€å§‹æ¨¡æ‹ŸAIå¤„ç†...');
            
            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ AIå¤„ç†ä¸­...</div>';
            
            // æ¨¡æ‹ŸAIå¤„ç†å»¶è¿Ÿ
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // AIè¾“å‡ºè¾ƒå°å°ºå¯¸çš„å›¾ç‰‡ (896Ã—1152)
                canvas.width = 896;
                canvas.height = 1152;
                
                // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#4ecdc4');
                gradient.addColorStop(1, '#ff6b6b');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // æ·»åŠ æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('AIå¤„ç†ç»“æœ', canvas.width/2, canvas.height/2 - 30);
                ctx.font = '24px Arial';
                ctx.fillText(`${canvas.width}Ã—${canvas.height}`, canvas.width/2, canvas.height/2 + 30);
                ctx.font = '18px Arial';
                ctx.fillText('éœ€è¦è°ƒæ•´åˆ°åŸå§‹å°ºå¯¸', canvas.width/2, canvas.height/2 + 80);
                
                // ç”Ÿæˆdata URL
                aiProcessedImageUrl = canvas.toDataURL('image/png');
                
                resultDiv.innerHTML = `
                    <img src="${aiProcessedImageUrl}" class="test-image" alt="AIå¤„ç†ç»“æœ">
                    <div class="status success">âœ… AIå¤„ç†å®Œæˆ</div>
                    <p>AIè¾“å‡ºå°ºå¯¸: ${canvas.width} Ã— ${canvas.height} åƒç´ </p>
                    <p>åŸå§‹å°ºå¯¸: ${originalDimensions.width} Ã— ${originalDimensions.height} åƒç´ </p>
                    <p>âš ï¸ å°ºå¯¸ä¸åŒ¹é…ï¼Œéœ€è¦è°ƒæ•´</p>
                `;
                
                log(`AIå¤„ç†å®Œæˆ: ${canvas.width}Ã—${canvas.height} (éœ€è¦è°ƒæ•´åˆ° ${originalDimensions.width}Ã—${originalDimensions.height})`);
            }, 1000);
        }
        
        // æµ‹è¯•å›¾ç‰‡å°ºå¯¸è°ƒæ•´
        function testResize() {
            if (!aiProcessedImageUrl) {
                alert('è¯·å…ˆè¿›è¡ŒAIå¤„ç†');
                return;
            }
            
            const resultDiv = document.getElementById('resizeResult');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ è°ƒæ•´å›¾ç‰‡å°ºå¯¸ä¸­...</div>';
            
            log('å¼€å§‹è°ƒæ•´å›¾ç‰‡å°ºå¯¸...');
            
            // ä½¿ç”¨å‰ç«¯Canvasè°ƒæ•´å›¾ç‰‡å°ºå¯¸
            fastResizeImage(aiProcessedImageUrl, originalDimensions.width, originalDimensions.height)
                .then(resizedUrl => {
                    resizedImageUrl = resizedUrl;
                    resultDiv.innerHTML = `
                        <img src="${resizedUrl}" class="test-image" alt="è°ƒæ•´åçš„å›¾ç‰‡">
                        <div class="status success">âœ… å›¾ç‰‡å°ºå¯¸è°ƒæ•´æˆåŠŸ</div>
                        <p>è°ƒæ•´åå°ºå¯¸: ${originalDimensions.width} Ã— ${originalDimensions.height} åƒç´ </p>
                        <p>âœ… ä¸åŸå§‹å°ºå¯¸ä¸€è‡´</p>
                    `;
                    log(`å›¾ç‰‡å°ºå¯¸è°ƒæ•´æˆåŠŸ: ${originalDimensions.width}Ã—${originalDimensions.height}`);
                })
                .catch(error => {
                    resultDiv.innerHTML = `
                        <div class="status error">âŒ å›¾ç‰‡å°ºå¯¸è°ƒæ•´å¤±è´¥: ${error.message}</div>
                    `;
                    log(`å›¾ç‰‡å°ºå¯¸è°ƒæ•´å¤±è´¥: ${error.message}`);
                });
        }
        
        // æµ‹è¯•ä¸‹è½½åŠŸèƒ½
        function testDownload() {
            const imageUrl = resizedImageUrl || aiProcessedImageUrl || testImageDataUrl;
            
            if (!imageUrl) {
                alert('è¯·å…ˆåˆ›å»ºæˆ–å¤„ç†å›¾ç‰‡');
                return;
            }
            
            const resultDiv = document.getElementById('downloadResult');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ å‡†å¤‡ä¸‹è½½...</div>';
            
            log('å¼€å§‹ä¸‹è½½å›¾ç‰‡...');
            
            try {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = imageUrl;
                
                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                let filename = `image-${timestamp}.png`;
                
                // å¦‚æœè°ƒæ•´äº†å°ºå¯¸ï¼Œåœ¨æ–‡ä»¶åä¸­æ ‡æ³¨
                if (resizedImageUrl) {
                    filename = `image-${originalDimensions.width}x${originalDimensions.height}-${timestamp}.png`;
                }
                
                link.download = filename;
                link.style.display = 'none';
                
                // æ·»åŠ åˆ°DOMï¼Œç‚¹å‡»ï¼Œç„¶åæ¸…ç†
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                resultDiv.innerHTML = `
                    <div class="status success">âœ… å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼</div>
                    <p>æ–‡ä»¶å: ${filename}</p>
                    <p>å›¾ç‰‡å°ºå¯¸: ${resizedImageUrl ? `${originalDimensions.width}Ã—${originalDimensions.height}` : 'åŸå§‹å°ºå¯¸'}</p>
                `;
                log(`å›¾ç‰‡ä¸‹è½½æˆåŠŸ: ${filename}`);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥: ${error.message}</div>
                `;
                log(`å›¾ç‰‡ä¸‹è½½å¤±è´¥: ${error.message}`);
            }
        }
        
        // å‰ç«¯å›¾ç‰‡å°ºå¯¸è°ƒæ•´å‡½æ•°
        function fastResizeImage(imageUrl, targetWidth, targetHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const timeout = setTimeout(() => {
                    reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
                }, 10000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // ç»˜åˆ¶ç¼©æ”¾åçš„å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        
                        // è½¬æ¢ä¸ºé«˜è´¨é‡PNGæ ¼å¼
                        const resizedUrl = canvas.toDataURL('image/png', 1.0);
                        log(`å›¾ç‰‡å°ºå¯¸è°ƒæ•´å®Œæˆ: ${targetWidth}x${targetHeight}`);
                        resolve(resizedUrl);
                    } catch (error) {
                        log(`Canvaså¤„ç†å¤±è´¥: ${error.message}`);
                        reject(new Error('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message));
                    }
                };
                
                img.onerror = (error) => {
                    clearTimeout(timeout);
                    log(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${error}`);
                    reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                };
                
                img.src = imageUrl;
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ›å»ºæµ‹è¯•å›¾ç‰‡
        window.addEventListener('load', () => {
            log('å®Œæ•´åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            setTimeout(() => {
                createTestImage();
            }, 500);
        });
    </script>
</body>
</html>
